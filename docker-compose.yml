services:
  tailscale:
    image: tailscale/tailscale:stable
    container_name: tailscale
    network_mode: host

    cap_add:
      - NET_ADMIN
      - SYS_MODULE

    devices:
      - /dev/net/tun:/dev/net/tun

    volumes:
      - ./state:/var/lib/tailscale
      - ./config:/config:ro
      - ./scripts:/scripts:ro

    env_file:
      - .env
      - ./config/subnets.env

    environment:
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false

    command: >
      sh -c '
        /config/preflight.sh || true
        . /config/subnets.env
        tailscaled &
        sleep 3
        tailscale up \
          --authkey="$$TS_AUTHKEY" \
          --hostname="$$TS_HOSTNAME" \
          --advertise-routes="$$TS_SUBNETS$" \
          $$TS_EXTRA_FLAGS
        wait
      '

    restart: always
